@using GOKCafe.Web.Models.DTOs
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@{
    // Get products from backend API (passed from controller via ViewData)
    var paginatedProducts = ViewData["Products"] as PaginatedResponse<ProductDto>;
    var products = paginatedProducts?.Items ?? new List<ProductDto>();
    var totalPages = paginatedProducts?.TotalPages ?? 1;
    var currentPage = paginatedProducts?.PageNumber ?? 1;

    // Get categories and filters from ViewData
    var categories = ViewData["Categories"] as List<CategoryDto> ?? new List<CategoryDto>();
    var filters = ViewData["Filters"] as ProductFiltersDto;
    var selectedCategoryIds = ViewData["SelectedCategoryIds"] as List<string> ?? new List<string>();
    var searchTerm = ViewData["SearchTerm"] as string ?? string.Empty;
    var selectedFlavourIds = ViewData["SelectedFlavourIds"] as List<string> ?? new List<string>();
    var selectedEquipmentIds = ViewData["SelectedEquipmentIds"] as List<string> ?? new List<string>();
    var selectedInStock = ViewData["SelectedInStock"] as bool?;

    // Build category filter options from backend data
    var categoryOptions = new List<(string Name, Guid? Id, bool IsChecked)>
    {
        ("All categories", null, !selectedCategoryIds.Any())
    };

    foreach (var category in categories)
    {
        categoryOptions.Add((category.Name, category.Id, selectedCategoryIds.Contains(category.Id.ToString())));
    }

    // Build flavour profile options from API
    var flavourOptions = filters?.FlavourProfiles?.Select(fp => new
    {
        Id = fp.Id.ToString(),
        Name = fp.Name,
        IsChecked = selectedFlavourIds.Contains(fp.Id.ToString())
    }).ToList();

    // Build equipment options from API
    var equipmentOptions = filters?.Equipments?.Select(eq => new
    {
        Id = eq.Id.ToString(),
        Name = eq.Name,
        IsChecked = selectedEquipmentIds.Contains(eq.Id.ToString())
    }).ToList();

    // Build availability options from API
    var inStockCount = filters?.Availability?.InStockCount ?? 0;
    var outOfStockCount = filters?.Availability?.OutOfStockCount ?? 0;

    // Helper function to build pagination URL with all filters
    string BuildPaginationUrl(int page)
    {
        var queryParams = new List<string> { $"page={page}" };

        foreach (var catId in selectedCategoryIds)
        {
            queryParams.Add($"category={catId}");
        }

        if (!string.IsNullOrEmpty(searchTerm))
        {
            queryParams.Add($"search={System.Web.HttpUtility.UrlEncode(searchTerm)}");
        }

        return "?" + string.Join("&", queryParams);
    }
}

<!-- Products Grid Section -->
<section class="py-12 bg-white">
    <div class="container mx-auto px-4 sm:px-6 lg:px-4">
        <!-- Header with Title and Mobile Actions -->
        <div class="flex flex-row justify-between items-center mb-8">
            <!-- Page Title -->
            <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">PRODUCTS LIST</h1>

            <!-- Desktop Search Bar -->
            <div class="hidden md:block">
                <div class="relative">
                    <input
                        type="text"
                        id="productSearchInput"
                        value="@searchTerm"
                        placeholder="Search products..."
                        class="w-60 px-4 py-3 pl-12 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none text-lg"
                    />
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Mobile Icons (Search & Filter) -->
            <div class="flex md:hidden gap-4">
                <!-- Mobile Search Icon -->
                <button
                    id="mobileSearchBtn"
                    onclick="toggleMobileSearch()"
                    class="w-10 h-10 flex items-center justify-center border-2 border-gray-300 rounded-lg hover:border-primary transition-colors"
                    aria-label="Search">
                    <i class="fas fa-search text-gray-600"></i>
                </button>

                <!-- Mobile Filter Icon -->
                <button
                    id="mobileFilterBtn"
                    onclick="toggleMobileFilter()"
                    class="w-10 h-10 flex items-center justify-center border-2 border-gray-300 rounded-lg hover:border-primary transition-colors"
                    aria-label="Filter">
                    <i class="fas fa-filter text-gray-600"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Search Bar (Hidden by default) -->
        <div id="mobileSearchBar" class="hidden md:hidden mb-6">
            <div class="relative">
                <input
                    type="text"
                    id="mobileProductSearchInput"
                    value="@searchTerm"
                    placeholder="Search products..."
                    class="w-full px-4 py-3 pl-12 pr-12 border-2 border-gray-300 rounded-lg focus:border-primary focus:outline-none"
                />
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                <button
                    onclick="toggleMobileSearch()"
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>


        <div class="flex flex-col justify-between lg:flex-row gap-8">
            <!-- Filters Sidebar (Desktop Only) -->
            <aside class="hidden lg:block w-full lg:w-48 flex-shrink-0">
                <div class="space-y-6">
                    <!-- Category Filter (Dynamic from Backend) -->
                    <div class="border-b border-gray-200 pb-4">
                        <button
                            class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                            onclick="toggleFilter('category')">
                            <span>Product Category</span>
                            <i class="fas fa-chevron-up" id="category-icon"></i>
                        </button>
                        <div id="category-filter" class="space-y-3">
                            @foreach (var option in categoryOptions)
                            {
                                <label
                                    class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                    <input type="checkbox"
                                        class="category-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                        data-category-id="@option.Id" @(option.IsChecked ? "checked" : "")
                                        onchange="productFilterController.handleCategoryChange(this)">
                                    <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                </label>
                            }
                        </div>
                    </div>

                    <!-- Flavour Profile Filter (Dynamic from API) -->
                    @if (flavourOptions != null && flavourOptions.Any())
                    {
                        <div class="border-b border-gray-200 pb-4">
                            <button
                                class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                onclick="toggleFilter('flavour')">
                                <span>Flavour Profile</span>
                                <i class="fas fa-chevron-up" id="flavour-icon"></i>
                            </button>
                            <div id="flavour-filter" class="space-y-3">
                                @foreach (var option in flavourOptions)
                                {
                                    <label
                                        class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                        <input type="checkbox"
                                            class="flavour-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                            data-flavour-id="@option.Id" @(option.IsChecked ? "checked" : "")
                                            onchange="productFilterController.handleFlavourChange()">
                                        <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    <!-- Equipment Filter (Dynamic from API) -->
                    @if (equipmentOptions != null && equipmentOptions.Any())
                    {
                        <div class="border-b border-gray-200 pb-4">
                            <button
                                class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                onclick="toggleFilter('equipment')">
                                <span>Equipment</span>
                                <i class="fas fa-chevron-up" id="equipment-icon"></i>
                            </button>
                            <div id="equipment-filter" class="space-y-3">
                                @foreach (var option in equipmentOptions)
                                {
                                    <label
                                        class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                        <input type="checkbox"
                                            class="equipment-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                            data-equipment-id="@option.Id" @(option.IsChecked ? "checked" : "")
                                            onchange="productFilterController.handleEquipmentChange()">
                                        <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }

                    <!-- Availability Filter -->
                    <div class="border-b border-gray-200 pb-4">
                        <button
                            class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                            onclick="toggleFilter('availability')">
                            <span>Availability</span>
                            <i class="fas fa-chevron-up" id="availability-icon"></i>
                        </button>
                        <div id="availability-filter" class="space-y-3">
                            <label
                                class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                <input type="radio"
                                    name="availability"
                                    class="w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                    @(selectedInStock == null ? "checked" : "")
                                    onchange="productFilterController.handleAvailabilityChange(null)">
                                <span class="ml-3 text-sm text-gray-700">All Products</span>
                            </label>
                            <label
                                class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                <input type="radio"
                                    name="availability"
                                    class="w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                    @(selectedInStock == true ? "checked" : "")
                                    onchange="productFilterController.handleAvailabilityChange(true)">
                                <span class="ml-3 text-sm text-gray-700">In Stock (@inStockCount)</span>
                            </label>
                            <label
                                class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                <input type="radio"
                                    name="availability"
                                    class="w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                    @(selectedInStock == false ? "checked" : "")
                                    onchange="productFilterController.handleAvailabilityChange(false)">
                                <span class="ml-3 text-sm text-gray-700">Out of Stock (@outOfStockCount)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Products Grid -->
            <div class="lg:min-w-80">
                @if (products.Any())
                {
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-8 mb-12">
                        @foreach (var product in products)
                        {
                            var productUrl = $"/product-details?id={product.Id}";


                            <!-- Product Card -->
                            <div class="group">
                                <!-- Product Image -->
                                <a href="@productUrl" class="block overflow-hidden mb-4 flex items-center justify-center bg-[#E8DCC4] w-full h-[420px] relative cursor-pointer">
                                    @if (!string.IsNullOrEmpty(product.ImageUrl))
                                    {
                                        <img src="@product.ImageUrl" alt="@product.Name"
                                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                                    }
                                    else
                                    {
                                        <div class="w-full h-full bg-[#E8DCC4] flex items-center justify-center">
                                            <i class="fas fa-coffee text-6xl text-gray-400"></i>
                                        </div>
                                    }
                                </a>

                                <!-- Product Info -->
                                <div class="text-center w-full mb-4">
                                    <!-- Category -->
                                    <p class="text-sm font-medium text-gray-500 uppercase mb-1">@product.CategoryName</p>

                                    <!-- Title -->
                                    <h3 class="text-lg font-bold text-gray-900 mb-2 uppercase truncate">
                                        <a href="@productUrl" class="hover:text-primary transition-colors">@product.Name</a>
                                    </h3>

                                    <!-- Price -->
                                    <div class="text-gray-600 mb-2 flex items-center justify-center gap-2">
                                        @if (product.DiscountPrice.HasValue && product.DiscountPrice > 0 && product.DiscountPrice < product.Price)
                                        {
                                            var discountPercent = Math.Round(((product.Price - product.DiscountPrice.Value) / product.Price) * 100);
                                            // Format prices - show as integer if no decimal, otherwise show full price
                                            var priceDisplay = product.Price % 1 == 0 ? ((int)product.Price).ToString() : product.Price.ToString();
                                            var discountPriceDisplay = product.DiscountPrice.Value % 1 == 0 ? ((int)product.DiscountPrice.Value).ToString() : product.DiscountPrice.Value.ToString();
                                            <div>From</div>
                                            <span class="text-gray-400 line-through text-base">@priceDisplay</span>
                                            <span class="font-semibold text-primary text-lg">@discountPriceDisplay</span>
                                            <span class="bg-primary text-white px-3 py-1  rounded-xl text-sm font-bold">-@discountPercent%</span>
                                        }
                                        else
                                        {
                                            var priceDisplay = product.Price % 1 == 0 ? ((int)product.Price).ToString() : product.Price.ToString();
                                            <span>From <span class="font-semibold text-lg">@priceDisplay</span></span>
                                        }
                                    </div>
                                </div>

                                <!-- Buy Now Button -->
                                <button onclick="openProductModal('@product.Id')"
                                    class="block w-full px-4 py-3 border-2 border-primary text-primary font-semibold hover:bg-primary hover:text-white transition-all duration-300 cursor-pointer flex items-center justify-center gap-2">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>Buy Now</span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4  mb-12">
                        <div class="text-center">
                            <i class="fas fa-coffee text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">No products found.</p>
                        </div>
                    </div>
                }

                <!-- Pagination -->
                <div id="product-pagination" class="flex justify-center items-center gap-2 mt-8">
                    @if (totalPages > 1)
                    {
                        <!-- Previous Button -->
                        @if (currentPage > 1)
                        {
                            <a href="@BuildPaginationUrl(currentPage - 1)"
                                class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors rounded cursor-pointer">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        }
                        else
                        {
                            <span
                                class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-300 rounded cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </span>
                        }

                        @* Show first few pages *@
                            @for (int i = 1; i <= Math.Min(3, totalPages); i++)
                        {
                            if (i == currentPage)
                            {
                                <span
                                    class="w-12 h-12 flex items-center justify-center border-2 border-primary bg-primary text-white font-medium transition-colors rounded">
                                    @i
                                </span>
                            }
                            else
                            {
                                <a href="@BuildPaginationUrl(i)"
                                    class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors rounded cursor-pointer">
                                    @i
                                </a>
                            }
                        }

                        @* Show dots if there are more pages *@
                            @if (totalPages > 4)
                        {
                            <span class="px-2 text-gray-500">...</span>

                            @* Show last page *@
                                    if (currentPage == totalPages)
                            {
                                <span
                                    class="w-12 h-12 flex items-center justify-center border-2 border-primary bg-primary text-white font-medium transition-colors rounded">
                                    @totalPages
                                </span>
                            }
                            else
                            {
                                <a href="@BuildPaginationUrl(totalPages)"
                                    class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors rounded cursor-pointer">
                                    @totalPages
                                </a>
                            }
                        }

                        <!-- Next Button -->
                        @if (currentPage < totalPages)
                        {
                            <a href="@BuildPaginationUrl(currentPage + 1)"
                                class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors rounded cursor-pointer">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        }
                        else
                        {
                            <span
                                class="w-12 h-12 flex items-center justify-center border border-gray-300 text-gray-300 rounded cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </span>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Mobile Filter Modal -->
        <div id="mobileFilterModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-xl transform transition-transform duration-300 ease-in-out flex flex-col h-full">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                    <h2 class="text-xl font-semibold text-gray-900">Filters</h2>
                    <button
                        onclick="closeMobileFilter()"
                        class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>

                <!-- Modal Body (Scrollable) -->
                <div class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden p-4">
                    <div class="space-y-6">
                        <!-- Category Filter -->
                        <div class="border-b border-gray-200 pb-4">
                            <button
                                class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                onclick="toggleMobileFilterSection('category')">
                                <span>Product Category</span>
                                <i class="fas fa-chevron-up" id="mobile-category-icon"></i>
                            </button>
                            <div id="mobile-category-filter" class="space-y-3">
                                @foreach (var option in categoryOptions)
                                {
                                    <label
                                        class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                        <input type="checkbox"
                                            class="mobile-category-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                            data-category-id="@option.Id" @(option.IsChecked ? "checked" : "")
                                            onchange="productFilterController.handleMobileCategoryChange(this)">
                                        <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                    </label>
                                }
                            </div>
                        </div>

                        <!-- Flavour Profile Filter -->
                        @if (flavourOptions != null && flavourOptions.Any())
                        {
                            <div class="border-b border-gray-200 pb-4">
                                <button
                                    class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                    onclick="toggleMobileFilterSection('flavour')">
                                    <span>Flavour Profile</span>
                                    <i class="fas fa-chevron-up" id="mobile-flavour-icon"></i>
                                </button>
                                <div id="mobile-flavour-filter" class="space-y-3">
                                    @foreach (var option in flavourOptions)
                                    {
                                        <label
                                            class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                            <input type="checkbox"
                                                class="mobile-flavour-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                                data-flavour-id="@option.Id" @(option.IsChecked ? "checked" : "")>
                                            <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Equipment Filter -->
                        @if (equipmentOptions != null && equipmentOptions.Any())
                        {
                            <div class="border-b border-gray-200 pb-4">
                                <button
                                    class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                    onclick="toggleMobileFilterSection('equipment')">
                                    <span>Equipment</span>
                                    <i class="fas fa-chevron-up" id="mobile-equipment-icon"></i>
                                </button>
                                <div id="mobile-equipment-filter" class="space-y-3">
                                    @foreach (var option in equipmentOptions)
                                    {
                                        <label
                                            class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                            <input type="checkbox"
                                                class="mobile-equipment-checkbox w-5 h-5 accent-primary border-gray-300 rounded focus:ring-primary"
                                                data-equipment-id="@option.Id" @(option.IsChecked ? "checked" : "")>
                                            <span class="ml-3 text-sm text-gray-700">@option.Name</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Availability Filter -->
                        <div class="pb-4">
                            <button
                                class="flex items-center justify-between w-full text-left font-semibold text-gray-900 mb-4"
                                onclick="toggleMobileFilterSection('availability')">
                                <span>Availability</span>
                                <i class="fas fa-chevron-up" id="mobile-availability-icon"></i>
                            </button>
                            <div id="mobile-availability-filter" class="space-y-3">
                                <label
                                    class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                    <input type="radio"
                                        name="mobile-availability"
                                        class="mobile-availability-radio w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                        data-value=""
                                        @(selectedInStock == null ? "checked" : "")>
                                    <span class="ml-3 text-sm text-gray-700">All Products</span>
                                </label>
                                <label
                                    class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                    <input type="radio"
                                        name="mobile-availability"
                                        class="mobile-availability-radio w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                        data-value="true"
                                        @(selectedInStock == true ? "checked" : "")>
                                    <span class="ml-3 text-sm text-gray-700">In Stock (@inStockCount)</span>
                                </label>
                                <label
                                    class="flex items-center cursor-pointer hover:bg-primary/10 p-2 -m-2 rounded transition-colors">
                                    <input type="radio"
                                        name="mobile-availability"
                                        class="mobile-availability-radio w-5 h-5 accent-primary border-gray-300 focus:ring-primary"
                                        data-value="false"
                                        @(selectedInStock == false ? "checked" : "")>
                                    <span class="ml-3 text-sm text-gray-700">Out of Stock (@outOfStockCount)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="flex-shrink-0 p-4 border-t border-gray-200 bg-white flex gap-3">
                    <button
                        onclick="clearMobileFilters()"
                        class="flex-1 px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-colors rounded-lg">
                        Clear All
                    </button>
                    <button
                        onclick="applyMobileFilters()"
                        class="flex-1 px-4 py-3 bg-primary text-white font-semibold hover:bg-primary-dark transition-colors rounded-lg">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<script src="~/js/services/product-filter-service.js"></script>
<script src="~/js/controllers/product-grid-ui-controller.js"></script>
<script src="~/js/controllers/product-filter-controller.js"></script>
<script src="~/js/utils/mobile-modal-helper.js"></script>

<script>
    let productFilterController;

    document.addEventListener('DOMContentLoaded', function() {
        const filterService = new ProductFilterService(window.apiService);
        const uiController = new ProductGridUIController();
        productFilterController = new ProductFilterController(filterService, uiController);
        productFilterController.init();
        window.productFilterController = productFilterController;
    });
</script>
